#!/bin/bash
# Prevent writing to sensitive files or content containing secrets
# Hook Type: PreToolUse
# Matcher: Write
#
# Exit code 2 = block the write
# Exit code 0 = allow the write

FILE="$CLAUDE_FILE_PATHS"
CONTENT="$CLAUDE_TOOL_INPUT"

# Exit if no file specified
[[ -z "$FILE" ]] && exit 0

# Get just the filename for pattern matching
FILENAME=$(basename "$FILE")

# Sensitive file patterns to block
BLOCKED_PATTERNS=(
  # Environment files
  ".env"
  ".env.local"
  ".env.development"
  ".env.production"
  ".env.staging"
  ".env.*"

  # Credential files
  "credentials.json"
  "secrets.json"
  "secrets.yaml"
  "secrets.yml"

  # SSH/SSL keys
  "*.pem"
  "*.key"
  "*.p12"
  "*.pfx"
  "id_rsa"
  "id_rsa.pub"
  "id_ed25519"
  "id_ed25519.pub"
  "known_hosts"

  # Cloud credentials
  ".aws/credentials"
  ".gcloud/credentials"
  "service-account*.json"

  # Other sensitive files
  ".netrc"
  ".npmrc"  # May contain tokens
  ".pypirc"
)

# Check if file matches blocked patterns
for pattern in "${BLOCKED_PATTERNS[@]}"; do
  if [[ "$FILENAME" == $pattern ]] || [[ "$FILE" == *"/$pattern" ]] || [[ "$FILE" == *"$pattern" ]]; then
    echo "========================================" >&2
    echo "BLOCKED: Cannot write to sensitive file" >&2
    echo "File: $FILE" >&2
    echo "Pattern: $pattern" >&2
    echo "========================================" >&2
    echo "" >&2
    echo "If you need to modify this file, edit it manually." >&2
    exit 2
  fi
done

# Scan content for hardcoded secrets (warning only, not blocking)
# Uncomment 'exit 2' to block instead of warn
if [[ -n "$CONTENT" ]]; then
  SECRET_PATTERNS=(
    "API_KEY\s*[=:]"
    "SECRET_KEY\s*[=:]"
    "PASSWORD\s*[=:]"
    "PRIVATE_KEY\s*[=:]"
    "ACCESS_TOKEN\s*[=:]"
    "AUTH_TOKEN\s*[=:]"
    "BEARER\s+"
    "sk-[a-zA-Z0-9]{20,}"      # OpenAI-style keys
    "ghp_[a-zA-Z0-9]{36}"      # GitHub personal tokens
    "gho_[a-zA-Z0-9]{36}"      # GitHub OAuth tokens
    "-----BEGIN.*PRIVATE KEY-----"
  )

  for pattern in "${SECRET_PATTERNS[@]}"; do
    if echo "$CONTENT" | grep -qE "$pattern"; then
      echo "========================================" >&2
      echo "WARNING: Content may contain secrets" >&2
      echo "Pattern detected: $pattern" >&2
      echo "========================================" >&2
      echo "" >&2
      echo "Please review the content carefully." >&2
      # Uncomment to block instead of warn:
      # exit 2
      break
    fi
  done
fi

exit 0
